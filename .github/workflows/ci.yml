# cspell:ignore dtolnay, msrv, pathlib, tomllib

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 6 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  determine-toolchains:
    name: Determine toolchains
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      list: ${{ steps.generate.outputs.list }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        run: rustup toolchain install stable --profile minimal

      - id: generate
        name: Compute toolchain list
        run: |
          python3 <<'PY'
          import json, os, pathlib, re, subprocess, tomllib
          cargo = pathlib.Path('Cargo.toml').read_text()
          data = tomllib.loads(cargo)
          msrv = data['package']['rust-version']
          parts = (msrv.split('.') + ['0', '0'])[:3]
          major = int(parts[0])
          minor = int(parts[1])
          stable_version = subprocess.check_output(['rustup', 'run', 'stable', 'rustc', '--version'], text=True)
          m = re.search(r"rustc (\d+)\.(\d+)\.(\d+)", stable_version)
          stable_minor = int(m.group(2))
          toolchains = [f"{major}.{value}.0" for value in range(minor, stable_minor + 1)]
          output = json.dumps(toolchains)
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"matrix={output}\n")
              fh.write(f"list={' '.join(toolchains)}\n")
          PY

  tests:
    name: Host tests (toolchain ${{ matrix.toolchain }})
    runs-on: ubuntu-latest
    needs: determine-toolchains
    strategy:
      fail-fast: false
      matrix:
        toolchain: ${{ fromJson(needs.determine-toolchains.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.toolchain }}

      - name: Cargo test (i2c)
        run: cargo +${{ matrix.toolchain }} test --features "i2c"

      - name: Cargo test (i2c async)
        run: cargo +${{ matrix.toolchain }} test --features "i2c async"

  aarch64-linux:
    name: AArch64 Linux checks (toolchain ${{ matrix.toolchain }})
    runs-on: ubuntu-latest
    needs: determine-toolchains
    strategy:
      fail-fast: false
      matrix:
        toolchain: ${{ fromJson(needs.determine-toolchains.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.toolchain }}
          targets: aarch64-unknown-linux-gnu

      - name: Cargo check (lib + example)
        run: |
          cargo +${{ matrix.toolchain }} check --target aarch64-unknown-linux-gnu --features "i2c std"
          cargo +${{ matrix.toolchain }} check --target aarch64-unknown-linux-gnu --features "i2c std" --example raspberry-pi-i2c

  thumbv8m:
    name: Thumbv8-M checks (toolchain ${{ matrix.toolchain }})
    runs-on: ubuntu-latest
    needs: determine-toolchains
    strategy:
      fail-fast: false
      matrix:
        toolchain: ${{ fromJson(needs.determine-toolchains.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.toolchain }}
          targets: thumbv8m.main-none-eabihf

      - name: Cargo check (lib + examples)
        run: |
          cargo +${{ matrix.toolchain }} check --target thumbv8m.main-none-eabihf -F "i2c"
          cargo +${{ matrix.toolchain }} check --target thumbv8m.main-none-eabihf -F "async i2c"
          cargo +${{ matrix.toolchain }} check --target thumbv8m.main-none-eabihf --features "async defmt i2c" --example rp2350-i2c-async
